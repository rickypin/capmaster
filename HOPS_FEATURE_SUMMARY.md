# è·¯ç”±è·³æ•°ç»Ÿè®¡åŠŸèƒ½æ€»ç»“

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

åœ¨ Match æ’ä»¶çš„ç«¯ç‚¹ç»Ÿè®¡åŠŸèƒ½ä¸­å¢åŠ äº†**è·¯ç”±è·³æ•°ç»Ÿè®¡**ï¼Œç”¨äºè®°å½• endpoint pairs ä¸­ client å’Œ server ä»æ•°æ®åŒ…å‘å‡ºä½ç½®åˆ°æŠ“åŒ…ç‚¹ç»è¿‡çš„è·¯ç”±è·³æ•°ã€‚

è¯¥åŠŸèƒ½å‚è€ƒäº† r2 app ä¸­ `host_list.rs` çš„ TTL åˆ¤æ–­é€»è¾‘ï¼Œé€šè¿‡åˆ†æ IP åŒ…å¤´ä¸­çš„ TTL (Time To Live) å€¼æ¥è®¡ç®—ç½‘ç»œè·³æ•°ã€‚

---

## ğŸ—ï¸ å®ç°æ¶æ„

### 1. TTL å·¥å…·æ¨¡å— (`capmaster/plugins/match/ttl_utils.py`)

æ–°å¢çš„å·¥å…·æ¨¡å—ï¼Œæä¾› TTL åˆ†æå’Œè·³æ•°è®¡ç®—åŠŸèƒ½ã€‚

#### æ ¸å¿ƒç±»ï¼š`TtlDelta`

```python
class TtlDelta:
    """Calculate network hops from TTL value."""
    
    def __init__(self, ttl: int):
        """
        Initialize TTL delta calculator.
        
        Determines the initial TTL based on common OS values:
        - 64: Linux/Unix systems
        - 128: Windows systems
        - 255: Network devices
        """
```

**ä¸»è¦åŠŸèƒ½ï¼š**
- è‡ªåŠ¨è¯†åˆ«åˆå§‹ TTL å€¼ï¼ˆ64/128/255ï¼‰
- è®¡ç®—ç½‘ç»œè·³æ•°ï¼š`hops = initial_ttl - observed_ttl`
- åˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¸­é—´ç½‘ç»œè®¾å¤‡

**ç¤ºä¾‹ï¼š**
```python
delta = TtlDelta(60)  # è§‚å¯Ÿåˆ°çš„ TTL å€¼
print(delta.hops)     # è¾“å‡º: 4 (å‡è®¾åˆå§‹ TTL=64)
print(delta.has_intermediate_device())  # è¾“å‡º: True
```

#### ä¾¿æ·å‡½æ•°

```python
def calculate_hops(ttl: int) -> int:
    """ä»å•ä¸ª TTL å€¼è®¡ç®—è·³æ•°"""

def most_common_hops(ttl_values: list[int]) -> int:
    """ä» TTL åˆ—è¡¨ä¸­è®¡ç®—æœ€å¸¸è§çš„è·³æ•°"""

def analyze_ttl_info(client_ttls: list[int], server_ttls: list[int]) -> dict:
    """ç»¼åˆåˆ†æå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ TTL ä¿¡æ¯"""
```

---

### 2. ç«¯ç‚¹ç»Ÿè®¡æ‰©å±• (`capmaster/plugins/match/endpoint_stats.py`)

#### æ•°æ®ç»“æ„æ‰©å±•

åœ¨ `EndpointPairStats` æ•°æ®ç±»ä¸­æ–°å¢ 4 ä¸ªå­—æ®µï¼š

```python
@dataclass
class EndpointPairStats:
    # ... åŸæœ‰å­—æ®µ ...
    
    # æ–°å¢å­—æ®µ
    client_hops_a: int = 0  # File A å®¢æˆ·ç«¯è·³æ•°
    server_hops_a: int = 0  # File A æœåŠ¡ç«¯è·³æ•°
    client_hops_b: int = 0  # File B å®¢æˆ·ç«¯è·³æ•°
    server_hops_b: int = 0  # File B æœåŠ¡ç«¯è·³æ•°
```

#### ç»Ÿè®¡æ”¶é›†é€»è¾‘

åœ¨ `EndpointStatsCollector.get_stats()` æ–¹æ³•ä¸­ï¼š

```python
# ä»å·²æ”¶é›†çš„ TTL å€¼åˆ—è¡¨è®¡ç®—è·³æ•°
client_hops_a = most_common_hops(self.client_ttls_a[(tuple_a, tuple_b)])
server_hops_a = most_common_hops(self.server_ttls_a[(tuple_a, tuple_b)])
client_hops_b = most_common_hops(self.client_ttls_b[(tuple_a, tuple_b)])
server_hops_b = most_common_hops(self.server_ttls_b[(tuple_a, tuple_b)])
```

**è®¾è®¡è¦ç‚¹ï¼š**
- åˆ©ç”¨ç°æœ‰çš„ TTL æ”¶é›†åŸºç¡€è®¾æ–½
- åœ¨èšåˆæ—¶è®¡ç®—è·³æ•°ï¼Œè€Œéæ¯ä¸ªè¿æ¥éƒ½è®¡ç®—ï¼ˆå‡å°‘å¼€é”€ï¼‰
- ä½¿ç”¨"æœ€å¸¸è§"è·³æ•°å¤„ç† TTL å€¼çš„å˜åŒ–

---

### 3. è¾“å‡ºæ ¼å¼æ›´æ–°

#### è¯¦ç»†æ ¼å¼è¾“å‡º

```
[1] Count: 1 | Confidence: HIGH
    File A: Client 192.168.1.100 â†’ Server 10.0.0.50:80 (TCP)
            TTL: Client=64 (hops=0), Server=60 (hops=4)
    File B: Client 172.16.0.200 â†’ Server 10.0.0.51:80 (TCP)
            TTL: Client=128 (hops=0), Server=120 (hops=8)
```

#### è¡¨æ ¼æ ¼å¼è¾“å‡º

```
Client IP (A)   | Server IP (A)   | Port (A) | TTL A (C/S)  | Hops A (C/S)  | ...
----------------------------------------------------------------------------------
192.168.1.100   | 10.0.0.50       | 80       | 64/60        | 0/4           | ...
```

**è¡¨æ ¼å®½åº¦ï¼š** ä» 180 å­—ç¬¦æ‰©å±•åˆ° 210 å­—ç¬¦ä»¥å®¹çº³æ–°åˆ—

---

## ğŸ” TTL è·³æ•°è®¡ç®—åŸç†

### æ ‡å‡†åˆå§‹ TTL å€¼

| æ“ä½œç³»ç»Ÿ/è®¾å¤‡ç±»å‹ | åˆå§‹ TTL |
|------------------|----------|
| Linux/Unix       | 64       |
| Windows          | 128      |
| ç½‘ç»œè®¾å¤‡         | 255      |

### è®¡ç®—å…¬å¼

```
ç½‘ç»œè·³æ•° = åˆå§‹ TTL - è§‚å¯Ÿåˆ°çš„ TTL
```

### ç¤ºä¾‹åœºæ™¯

#### åœºæ™¯ 1ï¼šLinux å®¢æˆ·ç«¯ç›´è¿
- è§‚å¯Ÿåˆ°çš„ TTL: 64
- åˆå§‹ TTL: 64
- **è·³æ•°: 0**ï¼ˆç›´æ¥è¿æ¥ï¼Œæ— ä¸­é—´è®¾å¤‡ï¼‰

#### åœºæ™¯ 2ï¼šç»è¿‡ 4 ä¸ªè·¯ç”±å™¨
- è§‚å¯Ÿåˆ°çš„ TTL: 60
- åˆå§‹ TTL: 64
- **è·³æ•°: 4**ï¼ˆç»è¿‡ 4 ä¸ªè·¯ç”±å™¨ï¼‰

#### åœºæ™¯ 3ï¼šWindows å®¢æˆ·ç«¯ç»è¿‡ 8 ä¸ªè·¯ç”±å™¨
- è§‚å¯Ÿåˆ°çš„ TTL: 120
- åˆå§‹ TTL: 128
- **è·³æ•°: 8**

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯• (`test_hops_feature.py`)

æµ‹è¯•è¦†ç›–ï¼š
1. âœ… TTL delta è®¡ç®—
2. âœ… è·³æ•°è®¡ç®—å‡½æ•°
3. âœ… æœ€å¸¸è§è·³æ•°ç»Ÿè®¡
4. âœ… TTL ä¿¡æ¯ç»¼åˆåˆ†æ
5. âœ… ç«¯ç‚¹ç»Ÿè®¡æ•°æ®ç»“æ„

**æµ‹è¯•ç»“æœï¼š** å…¨éƒ¨é€šè¿‡ âœ“

### é›†æˆæµ‹è¯• (`test_hops_integration.py`)

æ¨¡æ‹ŸçœŸå®åœºæ™¯ï¼š
- 3 ä¸ªç«¯ç‚¹å¯¹
- ä¸åŒçš„ TTL å€¼ç»„åˆ
- éªŒè¯è¯¦ç»†æ ¼å¼å’Œè¡¨æ ¼æ ¼å¼è¾“å‡º

**æµ‹è¯•ç»“æœï¼š** å…¨éƒ¨é€šè¿‡ âœ“

**ç¤ºä¾‹è¾“å‡ºï¼š**
```
Endpoint Pair 1:
  File A: 192.168.1.100 -> 10.0.0.50:80
    Client: TTL=64, Hops=0
    Server: TTL=60, Hops=4
  File B: 172.16.0.200 -> 10.0.0.51:80
    Client: TTL=128, Hops=0
    Server: TTL=120, Hops=8
```

---

## ğŸ“Š ä½¿ç”¨æ–¹æ³•

### å‘½ä»¤è¡Œä½¿ç”¨

```bash
# è¿è¡Œ match æ’ä»¶å¹¶æ˜¾ç¤ºç«¯ç‚¹ç»Ÿè®¡ï¼ˆåŒ…å«è·³æ•°ä¿¡æ¯ï¼‰
python -m capmaster match -i <input_dir> --endpoint-stats

# ç¤ºä¾‹
python -m capmaster match -i cases_02/TC-002-5-20220215-O/ --endpoint-stats
```

### è¾“å‡ºè¯´æ˜

è·³æ•°ä¿¡æ¯ä¼šè‡ªåŠ¨åŒ…å«åœ¨ç«¯ç‚¹ç»Ÿè®¡è¾“å‡ºä¸­ï¼š

1. **è¯¦ç»†æ ¼å¼**ï¼šæ¯ä¸ªç«¯ç‚¹å¯¹æ˜¾ç¤º TTL å’Œè·³æ•°
2. **è¡¨æ ¼æ ¼å¼**ï¼šæ–°å¢ "Hops A (C/S)" å’Œ "Hops B (C/S)" åˆ—

---

## ğŸ¯ åº”ç”¨åœºæ™¯

### 1. ç½‘ç»œæ‹“æ‰‘åˆ†æ
- åˆ¤æ–­å®¢æˆ·ç«¯/æœåŠ¡ç«¯ä¸æŠ“åŒ…ç‚¹ä¹‹é—´æ˜¯å¦å­˜åœ¨è·¯ç”±å™¨ç­‰ä¸­é—´è®¾å¤‡
- ä¼°ç®—ç½‘ç»œè·¯å¾„é•¿åº¦

### 2. æµé‡æ–¹å‘åˆ¤æ–­
- è¾…åŠ©åˆ¤æ–­æµé‡çš„çœŸå®æ¥æºå’Œç›®çš„åœ°
- ç»“åˆè·³æ•°ä¿¡æ¯æé«˜åŒ¹é…å‡†ç¡®æ€§

### 3. å¼‚å¸¸æ£€æµ‹
- TTL å€¼çš„å¼‚å¸¸å˜åŒ–å¯èƒ½è¡¨ç¤ºç½‘ç»œè·¯å¾„æ”¹å˜
- å¯èƒ½è¡¨ç¤ºå­˜åœ¨æ”»å‡»è¡Œä¸ºï¼ˆå¦‚ TTL æ¬ºéª—ï¼‰

### 4. æ€§èƒ½åˆ†æ
- è·³æ•°è¶Šå¤šï¼Œç½‘ç»œå»¶è¿Ÿé€šå¸¸è¶Šå¤§
- å¸®åŠ©è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ

---

## ğŸ“ è®¾è®¡å†³ç­–

### æ•°æ®åº“å†™å…¥åŠŸèƒ½

**âœ… å·²å®ç°ï¼** ç½‘ç»œè®¾å¤‡èŠ‚ç‚¹æ•°æ®åº“å†™å…¥åŠŸèƒ½å·²å®Œæˆã€‚

å½“ `hops != 0` æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨æ•°æ®åº“ä¸­æ’å…¥ç½‘ç»œè®¾å¤‡èŠ‚ç‚¹ï¼š
- **type=1001**: å®¢æˆ·ç«¯ä¸æŠ“åŒ…ç‚¹ä¹‹é—´çš„ç½‘ç»œè®¾å¤‡
- **type=1002**: æŠ“åŒ…ç‚¹ä¸æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œè®¾å¤‡

è¯¦è§ï¼š[NETWORK_DEVICE_DB_FEATURE.md](NETWORK_DEVICE_DB_FEATURE.md)

### ä¸ºä»€ä¹ˆä½¿ç”¨"æœ€å¸¸è§"è·³æ•°ï¼Ÿ

åŒä¸€ä¸ªç«¯ç‚¹å¯¹å¯èƒ½æœ‰å¤šä¸ªè¿æ¥ï¼Œæ¯ä¸ªè¿æ¥çš„ TTL å€¼å¯èƒ½ç•¥æœ‰ä¸åŒï¼ˆä¾‹å¦‚è´Ÿè½½å‡è¡¡ã€è·¯å¾„å˜åŒ–ï¼‰ã€‚

ä½¿ç”¨"æœ€å¸¸è§"è·³æ•°å¯ä»¥ï¼š
- è¿‡æ»¤å¼‚å¸¸å€¼
- è·å¾—æ›´ç¨³å®šçš„ç»Ÿè®¡ç»“æœ
- åæ˜ ä¸»è¦ç½‘ç»œè·¯å¾„

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ä¾èµ–å…³ç³»

```
ttl_utils.py
    â†“
endpoint_stats.py
    â†“
plugin.py (ä½¿ç”¨ç«¯ç‚¹ç»Ÿè®¡)
```

### æ€§èƒ½è€ƒè™‘

- TTL å€¼åœ¨è¿æ¥æå–æ—¶å·²æ”¶é›†ï¼ˆæ— é¢å¤–å¼€é”€ï¼‰
- è·³æ•°è®¡ç®—ä»…åœ¨èšåˆæ—¶è¿›è¡Œï¼ˆO(n) å¤æ‚åº¦ï¼‰
- ä½¿ç”¨ Counter é«˜æ•ˆç»Ÿè®¡æœ€å¸¸è§å€¼

### ä»£ç è´¨é‡

- âœ… ç±»å‹æ³¨è§£å®Œæ•´
- âœ… æ–‡æ¡£å­—ç¬¦ä¸²æ¸…æ™°
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–
- âœ… é›†æˆæµ‹è¯•éªŒè¯
- âœ… éµå¾ªé¡¹ç›®ä»£ç è§„èŒƒ

---

## ğŸ“š å‚è€ƒèµ„æ–™

### r2 app TTL é€»è¾‘

å‚è€ƒäº† `xuanwu-apps/r2/src/host_list.rs` ä¸­çš„å®ç°ï¼š

```rust
pub struct TtlDelta(u8);

impl TtlDelta {
    pub fn new(ttl: u8) -> Self {
        if ttl <= 64 {
            Self(64 - ttl)
        } else if ttl <= 128 {
            Self(128 - ttl)
        } else {
            Self(255 - ttl)
        }
    }
}
```

### ç›¸å…³æ–‡ä»¶

- `capmaster/plugins/match/ttl_utils.py` - TTL å·¥å…·æ¨¡å—
- `capmaster/plugins/match/endpoint_stats.py` - ç«¯ç‚¹ç»Ÿè®¡ï¼ˆå·²æ‰©å±•ï¼‰
- `capmaster/plugins/match/connection.py` - è¿æ¥æ•°æ®ç»“æ„ï¼ˆå·²æœ‰ TTL å­—æ®µï¼‰
- `test_hops_feature.py` - å•å…ƒæµ‹è¯•
- `test_hops_integration.py` - é›†æˆæµ‹è¯•

---

## âœ… æ€»ç»“

è·¯ç”±è·³æ•°ç»Ÿè®¡åŠŸèƒ½å·²æˆåŠŸå®ç°å¹¶é€šè¿‡æµ‹è¯•ï¼Œä¸»è¦ç‰¹ç‚¹ï¼š

1. **å‡†ç¡®æ€§**ï¼šåŸºäºæ ‡å‡† TTL å€¼è®¡ç®—ï¼Œå‚è€ƒä¸šç•Œå®è·µ
2. **æ˜“ç”¨æ€§**ï¼šè‡ªåŠ¨åŒ…å«åœ¨ç«¯ç‚¹ç»Ÿè®¡è¾“å‡ºä¸­ï¼Œæ— éœ€é¢å¤–å‚æ•°
3. **å¯æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºæœªæ¥æ‰©å±•ï¼ˆå¦‚å†™å…¥æ•°æ®åº“ï¼‰
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆ©ç”¨ç°æœ‰åŸºç¡€è®¾æ–½ï¼Œæœ€å°åŒ–é¢å¤–å¼€é”€
5. **æµ‹è¯•å®Œå¤‡**ï¼šå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡

è¯¥åŠŸèƒ½ä¸ºç½‘ç»œæ‹“æ‰‘åˆ†æå’Œæµé‡åŒ¹é…æä¾›äº†é‡è¦çš„è¾…åŠ©ä¿¡æ¯ã€‚

