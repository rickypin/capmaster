# TCP Timestamp åŒ¹é…é€»è¾‘è¯¦è§£

## æ¦‚è¿°

TCP Timestamp æ˜¯ TCP Options ä¸­çš„ä¸€ä¸ªå¯é€‰å­—æ®µï¼ˆRFC 1323ï¼‰ï¼Œç”¨äºï¼š
1. **å¾€è¿”æ—¶é—´æµ‹é‡ï¼ˆRTT Measurementï¼‰**
2. **é˜²æ­¢åºåˆ—å·å›ç»•ï¼ˆPAWS - Protection Against Wrapped Sequencesï¼‰**

åœ¨è¿æ¥åŒ¹é…ä¸­ï¼ŒTCP Timestamp æ˜¯ä¸€ä¸ª**ä¸­ç­‰å¼ºåº¦çš„ç‰¹å¾**ï¼Œæƒé‡ä¸º 10%ã€‚

**é‡è¦æ›´æ–°ï¼ˆ2025-11-12ï¼‰**ï¼šå·²ä¿®æ”¹é€»è¾‘ä»¥æ’é™¤ TSecr=0 çš„åŒ¹é…ï¼Œé¿å… SYN åŒ…çš„å‡é˜³æ€§ã€‚

## TCP Timestamp ç»“æ„

TCP Timestamp Option åŒ…å«ä¸¤ä¸ª 32 ä½å­—æ®µï¼š

```
+--------+--------+--------+--------+--------+--------+--------+--------+
| Kind=8 | Len=10 |       TSval (4 bytes)       |      TSecr (4 bytes)      |
+--------+--------+--------+--------+--------+--------+--------+--------+
```

- **TSval (Timestamp Value)**ï¼šå‘é€æ–¹çš„æ—¶é—´æˆ³å€¼
  - å•è°ƒé€’å¢ï¼ˆé€šå¸¸åŸºäºç³»ç»Ÿå¯åŠ¨æ—¶é—´ï¼‰
  - æ¯ä¸ªæ•°æ®åŒ…çš„ TSval éƒ½ä¼šå¢åŠ 
  - ä¸åŒä¸»æœºçš„ TSval èµ·å§‹å€¼ä¸åŒ

- **TSecr (Timestamp Echo Reply)**ï¼šå›æ˜¾å¯¹æ–¹çš„æ—¶é—´æˆ³å€¼
  - åœ¨ SYN åŒ…ä¸­ä¸º 0ï¼ˆå› ä¸ºè¿˜æ²¡æœ‰æ”¶åˆ°å¯¹æ–¹çš„æ—¶é—´æˆ³ï¼‰
  - åœ¨ SYN-ACK å’Œåç»­åŒ…ä¸­ï¼Œå›æ˜¾å¯¹æ–¹æœ€è¿‘å‘é€çš„ TSval

## æå–é€»è¾‘

### 1. æå–ä½ç½®

ä» **SYN åŒ…** çš„ TCP Options ä¸­æå–ï¼š

```python
# capmaster/core/connection/models.py (lines 365-372)
if syn_packet:
    tcp_timestamp_tsval = syn_packet.tcp_timestamp_tsval
    tcp_timestamp_tsecr = syn_packet.tcp_timestamp_tsecr
else:
    # No SYN packet - try to get timestamp from first packet
    tcp_timestamp_tsval = packets[0].tcp_timestamp_tsval if packets else ""
    tcp_timestamp_tsecr = packets[0].tcp_timestamp_tsecr if packets else ""
```

### 2. tshark æå–å­—æ®µ

```python
# capmaster/core/connection/extractor.py (lines 37-38)
"tcp.options.timestamp.tsval",  # TCP timestamp TSval
"tcp.options.timestamp.tsecr",  # TCP timestamp TSecr
```

### 3. æ•°æ®ç±»å‹

- å­˜å‚¨ä¸º**å­—ç¬¦ä¸²**ï¼ˆä¸æ˜¯æ•´æ•°ï¼‰
- ç©ºå­—ç¬¦ä¸² `""` è¡¨ç¤ºè¯¥å­—æ®µä¸å­˜åœ¨
- ç¤ºä¾‹å€¼ï¼š`"3576232891"`, `"0"`, `""`

## åŒ¹é…é€»è¾‘

### 1. å¯ç”¨æ€§åˆ¤æ–­

```python
# capmaster/core/connection/scorer.py (lines 571-577)
has_ts1 = bool(conn1.tcp_timestamp_tsval or conn1.tcp_timestamp_tsecr)
has_ts2 = bool(conn2.tcp_timestamp_tsval or conn2.tcp_timestamp_tsecr)

# If neither has timestamp, don't count
if not has_ts1 and not has_ts2:
    return 0.0, 0.0  # (score=0, available_weight=0)
```

**è§„åˆ™**ï¼š

- ä¸¤ä¸ªè¿æ¥éƒ½æ²¡æœ‰æ—¶é—´æˆ³ â†’ ç‰¹å¾**ä¸å¯ç”¨**ï¼ˆä¸è®¡å…¥æ€»æƒé‡ï¼‰
- è‡³å°‘ä¸€ä¸ªè¿æ¥æœ‰æ—¶é—´æˆ³ â†’ ç‰¹å¾**å¯ç”¨**ï¼ˆè®¡å…¥æ€»æƒé‡ï¼‰

### 2. åŒ¹é…æ¡ä»¶ï¼ˆOR é€»è¾‘ï¼Œå·²æ”¹è¿›ï¼‰

**å½“å‰å®ç°ï¼ˆ2025-11-12 æ›´æ–°ï¼‰**ï¼š

```python
# capmaster/core/connection/scorer.py (lines 581-595)
tsval_match = (
    conn1.tcp_timestamp_tsval
    and conn2.tcp_timestamp_tsval
    and conn1.tcp_timestamp_tsval == conn2.tcp_timestamp_tsval
)
# Exclude TSecr=0 to avoid false positives from SYN packets
tsecr_match = (
    conn1.tcp_timestamp_tsecr
    and conn2.tcp_timestamp_tsecr
    and conn1.tcp_timestamp_tsecr != "0"  # â† æ–°å¢ï¼šæ’é™¤ TSecr=0
    and conn1.tcp_timestamp_tsecr == conn2.tcp_timestamp_tsecr
)

if tsval_match or tsecr_match:
    return WEIGHT_TIMESTAMP, WEIGHT_TIMESTAMP  # (score=0.10, available=0.10)
```

**è§„åˆ™**ï¼š

- **TSval åŒ¹é…** æˆ– **TSecr åŒ¹é…ï¼ˆä¸” TSecr â‰  0ï¼‰** â†’ æ—¶é—´æˆ³åŒ¹é…
- åªè¦æœ‰ä¸€ä¸ªåŒ¹é…ï¼Œå°±å¾—åˆ†
- ä¸¤ä¸ªéƒ½ä¸åŒ¹é… â†’ ä¸å¾—åˆ†ï¼ˆä½†æƒé‡ä»è®¡å…¥åˆ†æ¯ï¼‰
- **æ’é™¤ TSecr=0**ï¼šé¿å…æ‰€æœ‰ SYN åŒ…éƒ½åŒ¹é…çš„å‡é˜³æ€§

### 3. è¯„åˆ†

| æƒ…å†µ | å¾—åˆ† | å¯ç”¨æƒé‡ | è¯´æ˜ |
|------|------|----------|------|
| ä¸¤ä¸ªè¿æ¥éƒ½æ²¡æœ‰æ—¶é—´æˆ³ | 0.0 | 0.0 | ç‰¹å¾ä¸å¯ç”¨ |
| è‡³å°‘ä¸€ä¸ªæœ‰æ—¶é—´æˆ³ï¼Œä¸”åŒ¹é… | 0.10 | 0.10 | åŒ¹é…æˆåŠŸ |
| è‡³å°‘ä¸€ä¸ªæœ‰æ—¶é—´æˆ³ï¼Œä½†ä¸åŒ¹é… | 0.0 | 0.10 | åŒ¹é…å¤±è´¥ |

## å®é™…æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹ï¼šç”¨æˆ·çš„åŒ¹é…ç»“æœï¼ˆä¿®æ”¹å‰ï¼‰

```text
Match 1: Score=0.40 | Evidence=ts shape(1.00) ipid*

Connection A: 10.52.170.71:36114 <-> 10.95.35.148:8080
  TSval: '3576232891'
  TSecr: '0'

Connection B: 10.52.170.71:44614 <-> 10.95.35.148:8080
  TSval: '3575929991'
  TSecr: '0'
```

**ä¿®æ”¹å‰çš„åˆ†æ**ï¼š

1. **TSval æ¯”è¾ƒ**ï¼š
   - A: `3576232891`
   - B: `3575929991`
   - **ä¸åŒ¹é…**ï¼ˆå·®å€¼ 302,900ï¼‰

2. **TSecr æ¯”è¾ƒ**ï¼š
   - A: `0`
   - B: `0`
   - **åŒ¹é…ï¼**ï¼ˆéƒ½æ˜¯ 0ï¼‰

3. **ç»“æœï¼ˆä¿®æ”¹å‰ï¼‰**ï¼š
   - TSval ä¸åŒ¹é…ï¼Œä½† TSecr åŒ¹é…
   - æ ¹æ® OR é€»è¾‘ï¼Œæ—¶é—´æˆ³åŒ¹é…æˆåŠŸ
   - å¾—åˆ† +0.10ï¼Œè¯æ®æ·»åŠ  `ts`
   - **è¿™æ˜¯å‡é˜³æ€§ï¼**

**ä¿®æ”¹åçš„ç»“æœ**ï¼š

- TSecr=0 è¢«æ’é™¤ï¼Œä¸å†åŒ¹é…
- TSval ä¸åŒ¹é…
- æ—¶é—´æˆ³**ä¸åŒ¹é…**
- å¾—åˆ† +0.0ï¼Œ**æ²¡æœ‰** `ts` è¯æ®
- **å‡é˜³æ€§è¢«æ¶ˆé™¤ï¼**

### ä¸ºä»€ä¹ˆ TSecr éƒ½æ˜¯ 0ï¼Ÿ

å› ä¸ºè¿™æ˜¯ **SYN åŒ…** çš„æ—¶é—´æˆ³ï¼š

- SYN åŒ…æ˜¯è¿æ¥å»ºç«‹çš„ç¬¬ä¸€ä¸ªåŒ…
- æ­¤æ—¶è¿˜æ²¡æœ‰æ”¶åˆ°å¯¹æ–¹çš„æ—¶é—´æˆ³
- æ‰€ä»¥ TSecr ä¸º 0ï¼ˆæ²¡æœ‰å¯å›æ˜¾çš„å€¼ï¼‰

### ä¸ºä»€ä¹ˆ TSval ä¸åŒï¼Ÿ

å¯èƒ½çš„åŸå› ï¼š

1. **æ•è·æ—¶é—´ä¸åŒ**ï¼š
   - ä¸¤ä¸ªæ•è·ç‚¹çš„æ—¶é—´å·®å¼‚
   - TSval æ˜¯å•è°ƒé€’å¢çš„ï¼Œæ—¶é—´å·®ä¼šå¯¼è‡´ TSval ä¸åŒ
   - å·®å€¼ 302,900 çº¦ç­‰äº 302 ç§’ï¼ˆå‡è®¾ TSval å•ä½æ˜¯æ¯«ç§’ï¼‰

2. **ä¸åŒçš„è¿æ¥**ï¼š
   - è¿™ä¸¤ä¸ªè¿æ¥å¯èƒ½æ˜¯ä¸åŒçš„ TCP è¿æ¥
   - åªæ˜¯ç¢°å·§ TSecr éƒ½æ˜¯ 0ï¼ˆéƒ½æ˜¯ SYN åŒ…ï¼‰

## ä¸ºä»€ä¹ˆä½¿ç”¨ OR é€»è¾‘ï¼Ÿ

### è®¾è®¡ç†ç”±

1. **TSval çš„ä¸ç¨³å®šæ€§**ï¼š
   - TSval æ˜¯å•è°ƒé€’å¢çš„
   - åœ¨ä¸åŒæ•è·ç‚¹ï¼ŒTSval å¯èƒ½ä¸åŒï¼ˆæ—¶é—´å·®å¼‚ï¼‰
   - ä¸é€‚åˆä½œä¸ºå”¯ä¸€çš„åŒ¹é…æ¡ä»¶

2. **TSecr çš„ç¨³å®šæ€§**ï¼š
   - TSecr å›æ˜¾å¯¹æ–¹çš„æ—¶é—´æˆ³
   - åœ¨åŒä¸€è¿æ¥ä¸­ï¼ŒTSecr åº”è¯¥ç›¸åŒ
   - ä½†åœ¨ SYN åŒ…ä¸­ï¼ŒTSecr æ€»æ˜¯ 0

3. **äº’è¡¥æ€§**ï¼š
   - SYN åŒ…ï¼šTSecr=0ï¼ŒTSval å¯èƒ½ä¸åŒ
   - æ•°æ®åŒ…ï¼šTSecr å¯èƒ½ç›¸åŒï¼ŒTSval å¯èƒ½ä¸åŒ
   - ä½¿ç”¨ OR é€»è¾‘å¯ä»¥è¦†ç›–æ›´å¤šåœºæ™¯

### æ½œåœ¨é—®é¢˜

**TSecr=0 çš„å‡é˜³æ€§**ï¼š
- æ‰€æœ‰ SYN åŒ…çš„ TSecr éƒ½æ˜¯ 0
- å¦‚æœä¸¤ä¸ªè¿æ¥éƒ½æ˜¯ SYN åŒ…ï¼ŒTSecr éƒ½æ˜¯ 0
- è¿™ä¼šå¯¼è‡´å‡é˜³æ€§ï¼ˆè¯¯åŒ¹é…ï¼‰

**ç¤ºä¾‹**ï¼š
```
Connection A: TSval=3576232891, TSecr=0  (SYN)
Connection B: TSval=3575929991, TSecr=0  (SYN)
â†’ TSecr åŒ¹é…ï¼ˆéƒ½æ˜¯ 0ï¼‰ï¼Œä½†å®é™…ä¸Šæ˜¯ä¸åŒçš„è¿æ¥
```

## æ”¹è¿›å®æ–½

### âœ… å·²å®æ–½ï¼šæ’é™¤ TSecr=0 çš„åŒ¹é…

**ä¿®æ”¹æ—¥æœŸ**ï¼š2025-11-12

**ä¿®æ”¹å†…å®¹**ï¼š

```python
# ä¿®æ”¹åçš„é€»è¾‘ï¼ˆå·²å®æ–½ï¼‰
tsecr_match = (
    conn1.tcp_timestamp_tsecr
    and conn2.tcp_timestamp_tsecr
    and conn1.tcp_timestamp_tsecr != "0"  # â† å·²æ·»åŠ ï¼šæ’é™¤ 0
    and conn1.tcp_timestamp_tsecr == conn2.tcp_timestamp_tsecr
)
```

**ä¼˜ç‚¹**ï¼š

- âœ… é¿å… SYN åŒ…çš„å‡é˜³æ€§
- âœ… æé«˜åŒ¹é…å‡†ç¡®æ€§
- âœ… å‡å°‘è¯¯åŒ¹é…

**ç¼ºç‚¹**ï¼š

- âš ï¸ å¯èƒ½é™ä½åŒ¹é…ç‡ï¼ˆSYN åŒ…æ— æ³•é€šè¿‡ TSecr åŒ¹é…ï¼‰
- âš ï¸ ä½†è¿™æ˜¯æ­£ç¡®çš„è¡Œä¸ºï¼ˆSYN åŒ…çš„ TSecr=0 ä¸åº”è¯¥åŒ¹é…ï¼‰

### ğŸ’¡ æœªæ¥æ”¹è¿›å»ºè®®ï¼šä½¿ç”¨ TSval å·®å€¼é˜ˆå€¼

```python
# å…è®¸ TSval æœ‰ä¸€å®šå·®å¼‚ï¼ˆæœªå®æ–½ï¼‰
tsval_diff = abs(int(conn1.tcp_timestamp_tsval) - int(conn2.tcp_timestamp_tsval))
tsval_match = tsval_diff < THRESHOLD  # ä¾‹å¦‚ 1000 æ¯«ç§’
```

**ä¼˜ç‚¹**ï¼š

- å…è®¸æ•è·æ—¶é—´å·®å¼‚
- æé«˜åŒ¹é…ç‡

**ç¼ºç‚¹**ï¼š

- å¢åŠ å‡é˜³æ€§é£é™©
- éœ€è¦è°ƒæ•´é˜ˆå€¼
- éœ€è¦æ›´å¤šæµ‹è¯•æ•°æ®éªŒè¯

### 3. ç»“åˆå…¶ä»–ç‰¹å¾

å½“å‰å®ç°å·²ç»è¿™æ ·åšäº†ï¼š
- æ—¶é—´æˆ³åªæ˜¯ 8 ä¸ªç‰¹å¾ä¹‹ä¸€
- æƒé‡åªæœ‰ 10%
- éœ€è¦ç»“åˆå…¶ä»–ç‰¹å¾ï¼ˆIPIDã€ISNã€åŒ…é•¿åº¦ç­‰ï¼‰æ‰èƒ½åŒ¹é…

## æ€»ç»“

### å½“å‰å®ç°ï¼ˆ2025-11-12 æ›´æ–°ï¼‰

| ç‰¹æ€§ | å€¼ |
|------|-----|
| æƒé‡ | 10% (WEIGHT_TIMESTAMP = 0.10) |
| åŒ¹é…æ¡ä»¶ | TSval åŒ¹é… **æˆ–** TSecr åŒ¹é…ï¼ˆ**ä¸” TSecr â‰  0**ï¼‰ |
| å¯ç”¨æ€§ | è‡³å°‘ä¸€ä¸ªè¿æ¥æœ‰æ—¶é—´æˆ³ |
| æ•°æ®ç±»å‹ | å­—ç¬¦ä¸²ï¼ˆä» tshark æå–ï¼‰ |
| æå–ä½ç½® | SYN åŒ…ï¼ˆæˆ–ç¬¬ä¸€ä¸ªåŒ…ï¼‰ |
| TSecr=0 å¤„ç† | **æ’é™¤**ï¼ˆé¿å… SYN åŒ…å‡é˜³æ€§ï¼‰ |

### ä¼˜ç‚¹

âœ… **çµæ´»æ€§**ï¼šOR é€»è¾‘è¦†ç›–å¤šç§åœºæ™¯
âœ… **å®¹é”™æ€§**ï¼šå…è®¸ TSval ä¸åŒï¼ˆæ—¶é—´å·®å¼‚ï¼‰
âœ… **å‡†ç¡®æ€§**ï¼šæ’é™¤ TSecr=0ï¼Œé¿å… SYN åŒ…å‡é˜³æ€§
âœ… **ç®€å•æ€§**ï¼šå®ç°ç®€å•ï¼Œæ˜“äºç†è§£

### ç¼ºç‚¹

âš ï¸ **å¼±åŒºåˆ†**ï¼šæƒé‡åªæœ‰ 10%ï¼ŒåŒºåˆ†èƒ½åŠ›æœ‰é™
âš ï¸ **ä¾èµ–æ€§**ï¼šéœ€è¦ç»“åˆå…¶ä»–ç‰¹å¾æ‰èƒ½å‡†ç¡®åŒ¹é…
âš ï¸ **SYN åŒ…é™åˆ¶**ï¼šSYN åŒ…åªèƒ½é€šè¿‡ TSval åŒ¹é…ï¼ˆTSecr=0 è¢«æ’é™¤ï¼‰

### å®é™…æ•ˆæœï¼ˆä¿®æ”¹åï¼‰

åœ¨ç”¨æˆ·çš„æ¡ˆä¾‹ä¸­ï¼š

- ä¸¤ä¸ªè¿æ¥çš„ TSecr éƒ½æ˜¯ 0ï¼ˆSYN åŒ…ï¼‰
- TSval ä¸åŒï¼ˆå·®å€¼ 302,900ï¼‰
- **ä¿®æ”¹å‰**ï¼šTSecr=0 åŒ¹é…ï¼Œæ—¶é—´æˆ³åŒ¹é…ï¼ˆå‡é˜³æ€§ï¼‰
- **ä¿®æ”¹å**ï¼šTSecr=0 è¢«æ’é™¤ï¼Œæ—¶é—´æˆ³ä¸åŒ¹é…ï¼ˆæ­£ç¡®ï¼‰
- **å‡é˜³æ€§è¢«æ¶ˆé™¤ï¼**

### æ”¹è¿›æ•ˆæœ

| æŒ‡æ ‡ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| TSecr=0 åŒ¹é… | âœ“ åŒ¹é…ï¼ˆå‡é˜³æ€§ï¼‰ | âœ— æ’é™¤ |
| ç”¨æˆ·æ¡ˆä¾‹æ—¶é—´æˆ³åŒ¹é… | âœ“ åŒ¹é… | âœ— ä¸åŒ¹é… |
| å‡é˜³æ€§ | å­˜åœ¨ | æ¶ˆé™¤ |
| å‡†ç¡®æ€§ | ä½ | é«˜ |

## ç›¸å…³ä»£ç 

- `capmaster/core/connection/extractor.py` (lines 37-38, 184-185)
- `capmaster/core/connection/models.py` (lines 59-63, 215-219, 365-372)
- `capmaster/core/connection/scorer.py` (lines 556-595, 768-785)

## å‚è€ƒ

- RFC 1323: TCP Extensions for High Performance
- RFC 7323: TCP Extensions for High Performance (æ›´æ–°ç‰ˆ)
- Wireshark TCP Timestamp æ–‡æ¡£

