# 基数检测原理图解

## 场景1: Web服务器（典型的高基数服务端）

```
服务端: 192.168.1.100:80
基数 = 5 (服务5个不同的客户端IP)

                    ┌─────────────────────┐
                    │  192.168.1.100:80   │
                    │    (Web Server)     │
                    │   Cardinality: 5    │
                    └──────────┬──────────┘
                               │
              ┌────────────────┼────────────────┬────────────┐
              │                │                │            │
              ▼                ▼                ▼            ▼
    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ...
    │ 10.0.0.1     │  │ 10.0.0.2     │  │ 10.0.0.3     │
    │   :50001     │  │   :50002     │  │   :50003     │
    │ Card: 1      │  │ Card: 1      │  │ Card: 1      │
    └──────────────┘  └──────────────┘  └──────────────┘

判断: 192.168.1.100:80 是服务端 (基数 5 >> 1)
置信度: HIGH
```

## 场景2: 数据库服务器（中等基数）

```
服务端: 10.0.2.100:3306
基数 = 3 (服务3个应用服务器)

                    ┌─────────────────────┐
                    │  10.0.2.100:3306    │
                    │   (MySQL Server)    │
                    │   Cardinality: 3    │
                    └──────────┬──────────┘
                               │
              ┌────────────────┼────────────────┐
              │                │                │
              ▼                ▼                ▼
    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
    │ 10.0.1.10    │  │ 10.0.1.11    │  │ 10.0.1.12    │
    │   :40001     │  │   :40002     │  │   :40003     │
    │ Card: 1      │  │ Card: 1      │  │ Card: 1      │
    └──────────────┘  └──────────────┘  └──────────────┘

判断: 10.0.2.100:3306 是服务端 (基数 3 > 1)
置信度: MEDIUM (基数 < 5)
```

## 场景3: 点对点连接（基数相同）

```
节点1: 10.0.0.1:50001
节点2: 10.0.0.2:60001
两端基数都是 1

    ┌──────────────┐              ┌──────────────┐
    │ 10.0.0.1     │◄────────────►│ 10.0.0.2     │
    │   :50001     │              │   :60001     │
    │ Card: 1      │              │ Card: 1      │
    └──────────────┘              └──────────────┘

判断: 无法通过基数判断
置信度: UNKNOWN
回退: 使用端口号比较 (50001 < 60001, 选择60001为服务端)
```

## 场景4: 负载均衡（多个服务端）

```
3个后端服务器，每个服务约33个客户端

    ┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
    │ 10.0.2.101:8080 │       │ 10.0.2.102:8080 │       │ 10.0.2.103:8080 │
    │  (Backend 1)    │       │  (Backend 2)    │       │  (Backend 3)    │
    │  Card: 33       │       │  Card: 34       │       │  Card: 33       │
    └────────┬────────┘       └────────┬────────┘       └────────┬────────┘
             │                         │                         │
    ┌────────┴────────┬────────────────┴────────┬────────────────┴────────┐
    │                 │                         │                         │
    ▼                 ▼                         ▼                         ▼
┌─────────┐       ┌─────────┐             ┌─────────┐               ┌─────────┐
│Client 1 │       │Client 2 │    ...      │Client99 │               │Client100│
│Card: 1  │       │Card: 1  │             │Card: 1  │               │Card: 1  │
└─────────┘       └─────────┘             └─────────┘               └─────────┘

判断: 每个后端服务器都被正确识别为服务端
置信度: HIGH (基数 33-34 >> 1)
```

## 检测流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    开始服务端检测                              │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
              ┌──────────────────────┐
              │ 有SYN包方向信息？      │
              └──────┬───────┬───────┘
                     │YES    │NO
                     ▼       │
            ┌────────────┐   │
            │ 使用SYN方向 │   │
            │ HIGH置信度  │   │
            └────────────┘   │
                             ▼
                  ┌──────────────────────┐
                  │ 端口在知名列表中？     │
                  └──────┬───────┬───────┘
                         │YES    │NO
                         ▼       │
                ┌────────────┐   │
                │ 使用端口启发│   │
                │ HIGH/MEDIUM │   │
                └────────────┘   │
                                 ▼
                      ┌──────────────────────┐
                      │ 基数分析可用？         │
                      └──────┬───────┬───────┘
                             │YES    │NO
                             ▼       │
                    ┌────────────┐   │
                    │ 基数差异显著│   │
                    │ HIGH/MEDIUM │   │
                    └────────────┘   │
                                     ▼
                          ┌──────────────────┐
                          │ 使用端口号比较    │
                          │ VERY_LOW置信度   │
                          └──────────────────┘
```

## 基数计算示例

### 示例数据

```
连接1: 10.0.0.1:50001 <-> 192.168.1.100:80
连接2: 10.0.0.2:50002 <-> 192.168.1.100:80
连接3: 10.0.0.3:50003 <-> 192.168.1.100:80
连接4: 10.0.0.1:50004 <-> 192.168.1.100:80
连接5: 10.0.0.2:50005 <-> 192.168.1.100:80
```

### 基数统计表

| 端点 | 服务的唯一客户端IP | 基数 |
|------|-------------------|------|
| 192.168.1.100:80 | {10.0.0.1, 10.0.0.2, 10.0.0.3} | 3 |
| 10.0.0.1:50001 | {192.168.1.100} | 1 |
| 10.0.0.2:50002 | {192.168.1.100} | 1 |
| 10.0.0.3:50003 | {192.168.1.100} | 1 |
| 10.0.0.1:50004 | {192.168.1.100} | 1 |
| 10.0.0.2:50005 | {192.168.1.100} | 1 |

### 判断逻辑

对于连接1: `10.0.0.1:50001 <-> 192.168.1.100:80`

```python
endpoint1 = (10.0.0.1, 50001)
endpoint2 = (192.168.1.100, 80)

cardinality1 = 1  # 只连接到1个服务端IP
cardinality2 = 3  # 服务3个不同的客户端IP

# 判断
if cardinality2 >= 2 and cardinality1 < 2:
    # endpoint2 是服务端
    server = 192.168.1.100:80
    confidence = "MEDIUM"  # 基数3，未达到5的HIGH阈值
```

## 置信度阈值

```
基数 >= 5:     HIGH    ████████████████████ (非常可靠)
基数 2-4:      MEDIUM  ████████████         (较可靠)
基数 1:        -       ████                 (无法判断)
比率 >= 3:1:   MEDIUM  ████████████         (较可靠)
基数相近:      UNKNOWN ██                   (无法判断)
```

## 实际应用场景对比

### 传统方法 vs 基数分析

| 场景 | 端口 | SYN包 | 传统方法 | 基数分析 |
|------|------|-------|----------|----------|
| Web服务器 | 80 | ✓ | HIGH (端口) | HIGH (基数50+) |
| 自定义端口服务 | 8888 | ✓ | HIGH (SYN) | HIGH (基数20+) |
| 自定义端口服务 | 8888 | ✗ | VERY_LOW (兜底) | HIGH (基数20+) ⭐ |
| 数据库 | 3306 | ✓ | HIGH (端口) | MEDIUM (基数3) |
| 数据库 | 26301 | ✗ | VERY_LOW (兜底) | MEDIUM (基数3) ⭐ |
| P2P连接 | 随机 | ✗ | VERY_LOW (兜底) | UNKNOWN (基数1) |

⭐ = 基数分析显著改善的场景

## 总结

基数分析通过统计每个端点服务的唯一客户端数量，利用"服务端服务多个客户端"这一本质特征，在以下场景中显著提升了服务端识别的准确性：

1. **非标准端口服务** - 不依赖端口号
2. **无SYN包场景** - 不依赖连接建立过程
3. **大规模连接** - 统计特征更可靠

这是对传统检测方法的重要补充，使服务端识别更加智能和鲁棒。

