# 行为匹配策略验证报告

## 执行概要

本报告基于 **33 个真实用例**，对比了**推荐的行为匹配配置**与**原有 auto 模式**的效果。

### 推荐配置
```
overlap:  0%   (时间重叠)
duration: 40%  (持续时间相似度)
iat:      30%  (报文间隔相似度)
bytes:    30%  (总字节数相似度)
```

## 验证结果

### 总体表现

| 指标 | Auto 模式 | Behavioral (推荐) | 提升 |
|------|-----------|-------------------|------|
| **总匹配数** | 4,544 | 7,849 | **+3,305 (+72.7%)** |

### 用例对比分布

| 结果 | 用例数 | 占比 |
|------|--------|------|
| Behavioral 更优 | 9 | 27.3% |
| Auto 更优 | 6 | 18.2% |
| 持平 | 18 | 54.5% |

## 详细分析

### Top 10 提升最大的用例

| 排名 | 用例 | Auto | Behavioral | 提升 |
|------|------|------|------------|------|
| 1 | TC-035-04-20240104 | 1,169 | 2,230 | +1,061 (+90.8%) |
| 2 | dbs_1112 | 0 | 930 | +930 |
| 3 | dbs_1113_2 | 11 | 662 | +651 (+5,918%) |
| 4 | TC-034-3-20210604-O | 504 | 1,041 | +537 (+106.5%) |
| 5 | TC-034-4-20210901 | 95 | 358 | +263 (+276.8%) |
| 6 | TC-001-1-20160407 | 63 | 166 | +103 (+163.5%) |
| 7 | TC-046-2-20240314 | 0 | 75 | +75 |
| 8 | TC-002-5-20220215-O | 4 | 33 | +29 (+725%) |
| 9 | dbs_1110 | 0 | 15 | +15 |
| 10 | TC-001-4-20190810 | 0 | 0 | 0 |

### Top 6 下降的用例

| 排名 | 用例 | Auto | Behavioral | 下降 |
|------|------|------|------------|------|
| 1 | TC-006-01-20180531 | 2,333 | 1,980 | -353 (-15.1%) |
| 2 | TC-044-4-20231011 | 2 | 0 | -2 |
| 3 | dbs_fw_Masked | 1 | 0 | -1 |
| 4 | aomenjinguanju | 12 | 11 | -1 |
| 5 | TC-054-1-20230825 | 7 | 6 | -1 |
| 6 | TC-001-2-20130627 | 1 | 0 | -1 |

## 关键发现

### 1. 显著提升场景
- **两跳抓包场景**：在时间不同步的两跳抓包场景中，推荐配置表现优异
  - 例如 `dbs_1112`、`dbs_1113_2`、`dbs_1110` 等用例，auto 模式几乎无法匹配，而 behavioral 模式能够成功匹配
- **大规模连接**：在连接数较多的场景中，提升尤为明显
  - 例如 `TC-035-04-20240104`、`TC-034-3-20210604-O` 等

### 2. 轻微下降场景
- **TC-006-01-20180531**：唯一显著下降的用例（-353，-15.1%）
  - 可能原因：该用例的连接特征更适合基于 IPID/特征的精确匹配
  - 建议：针对此类场景可考虑混合策略
- **其他下降用例**：下降幅度很小（-1 到 -2），可忽略

### 3. 持平场景
- 54.5% 的用例结果持平，说明推荐配置在不适用的场景下也不会造成负面影响

## 结论与建议

### ✓ 推荐配置显著优于 auto 模式

**核心数据**：
- 总匹配数提升 **72.7%**
- 27.3% 的用例有显著提升
- 仅 18.2% 的用例有轻微下降
- 54.5% 的用例保持一致

### 建议

1. **将推荐配置设为 behavioral 模式的默认配置**
   ```bash
   capmaster match --mode behavioral  # 使用推荐配置
   ```

2. **针对特定场景的优化方向**
   - 对于 TC-006-01-20180531 类似的场景，可考虑：
     - 提供混合模式（behavioral + feature-based）
     - 或允许用户微调权重

3. **使用方法**
   ```bash
   # 使用推荐配置（默认）
   capmaster match -i /path/to/cases --mode behavioral
   
   # 自定义权重（如需微调）
   capmaster match -i /path/to/cases --mode behavioral \
     --behavioral-weight-overlap 0.0 \
     --behavioral-weight-duration 0.4 \
     --behavioral-weight-iat 0.3 \
     --behavioral-weight-bytes 0.3
   ```

## 附录

### 验证环境
- 用例数量：33 个（来自 `/Users/ricky/Downloads/2hops/`）
- 验证时间：2025-11-13
- 对比模式：
  - Auto 模式：原有的 F5/TLS + 特征匹配策略
  - Behavioral 模式：推荐配置（overlap=0%, duration=40%, iat=30%, bytes=30%）

### 相关文档
- [行为匹配调优指南](./BEHAVIORAL_MATCHING_TUNING.md)
- [插件扩展指南](./AI_PLUGIN_EXTENSION_GUIDE.md)

