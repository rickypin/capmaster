# Changelog: ç»å¯¹åºåˆ—å·ï¼ˆAbsolute ISNï¼‰ä¿®æ”¹

## ç‰ˆæœ¬ä¿¡æ¯
- **ä¿®æ”¹æ—¥æœŸ**: 2025-11-12
- **å½±å“èŒƒå›´**: Match æ’ä»¶
- **å˜æ›´ç±»å‹**: Bug ä¿®å¤ + åŠŸèƒ½å¢å¼º
- **ç ´åæ€§å˜æ›´**: æ˜¯ï¼ˆåŒ¹é…ç»“æœå¯èƒ½ä¼šå˜åŒ–ï¼‰

## é—®é¢˜æè¿°

### å‘ç°çš„é—®é¢˜
åœ¨åˆ†æç”¨æˆ·æä¾›çš„åŒ¹é…æ¡ˆä¾‹æ—¶ï¼Œå‘ç°å½“å‰ Match æ’ä»¶ä½¿ç”¨çš„æ˜¯**ç›¸å¯¹åºåˆ—å·ï¼ˆRelative Sequence Numbersï¼‰**ï¼Œå¯¼è‡´ï¼š

1. **æ‰€æœ‰è¿æ¥çš„ ISN éƒ½æ˜¯ 0**
   - tshark é»˜è®¤ä½¿ç”¨ç›¸å¯¹åºåˆ—å·æ¨¡å¼
   - åœ¨ç›¸å¯¹æ¨¡å¼ä¸‹ï¼ŒSYN åŒ…çš„åºåˆ—å·è¢«å½’ä¸€åŒ–ä¸º 0
   - æ‰€æœ‰æœ‰ SYN åŒ…çš„è¿æ¥ï¼Œå…¶ `client_isn` å’Œ `server_isn` éƒ½æ˜¯ 0

2. **ISN å¤±å»åŒºåˆ†èƒ½åŠ›**
   - ISN åŒ¹é…å˜æˆäº†"æ˜¯å¦éƒ½æœ‰ SYN åŒ…"çš„æ£€æŸ¥
   - æ— æ³•é€šè¿‡ ISN æ’é™¤ä¸åŒè¿æ¥çš„è¯¯åŒ¹é…
   - å¯¼è‡´å‡é˜³æ€§å¢åŠ 

3. **ä¸ Compare æ’ä»¶ä¸ä¸€è‡´**
   - Compare æ’ä»¶ä½¿ç”¨ç»å¯¹åºåˆ—å·
   - Match æ’ä»¶ä½¿ç”¨ç›¸å¯¹åºåˆ—å·
   - ä¸¤ä¸ªæ’ä»¶çš„è¡Œä¸ºä¸ä¸€è‡´

### ç”¨æˆ·æ¡ˆä¾‹åˆ†æ

ç”¨æˆ·è¿è¡Œ `capmaster match -i /Users/ricky/Downloads/2hops/dbs_1112` å¾—åˆ°ï¼š

```
Matched pairs: 2

[1] A: 10.52.170.71:36114 <-> 10.95.35.148:8080
    B: 10.52.170.71:44614 <-> 10.95.35.148:8080
    ç½®ä¿¡åº¦: 0.61 | è¯æ®: isnC isnS ts shape(1.00) ipid*

[2] A: 10.52.170.71:54750 <-> 10.52.170.70:8080
    B: 10.52.170.71:57938 <-> 10.52.170.70:8080
    ç½®ä¿¡åº¦: 0.68 | è¯æ®: isnC isnS ts shape(0.83) ipid
```

ç”¨æˆ·è¯¢é—®ä¸ºä»€ä¹ˆä¼šåŒ¹é…ä¸Šï¼Œæˆ‘ä»¬å‘ç°ï¼š
- è¯æ®ä¸­åŒ…å« `isnC` å’Œ `isnS`ï¼ˆISN åŒ¹é…ï¼‰
- ä½†å®é™…ä¸Šæ‰€æœ‰è¿æ¥çš„ ISN éƒ½æ˜¯ 0ï¼ˆç›¸å¯¹åºåˆ—å·ï¼‰
- è¿™æ˜¯**å‡é˜³æ€§**ï¼

## ä¿®æ”¹å†…å®¹

### 1. ä¿®æ”¹ `capmaster/core/connection/extractor.py`

æ·»åŠ  `-o tcp.relative_sequence_numbers:false` å‚æ•°ï¼Œä½¿ç”¨ç»å¯¹åºåˆ—å·ï¼š

```python
args = [
    "-r", str(pcap_file),
    "-Y", "tcp",
    # Use absolute sequence numbers for accurate ISN matching
    "-o", "tcp.relative_sequence_numbers:false",  # â† æ–°å¢
    "-o", "tcp.desegment_tcp_streams:false",
    ...
]
```

### 2. æ›´æ–° `capmaster/core/connection/scorer.py`

æ›´æ–° ISN è¯„åˆ†å‡½æ•°çš„æ³¨é‡Šï¼Œè¯´æ˜ç°åœ¨ä½¿ç”¨ç»å¯¹åºåˆ—å·ï¼š

```python
def _score_isn_client(self, conn1: TcpConnection, conn2: TcpConnection) -> tuple[float, float]:
    """Score client ISN similarity."""
    # ISN is only available if SYN packet was captured
    # We use syn_options as a proxy to check if SYN packet exists
    # (ISN=0 is valid when no SYN packet, not when using absolute sequence numbers)
    ...
```

### 3. æ›´æ–°æ–‡æ¡£

- `docs/MATCH_LOGIC_COMPLETE.md`: æ·»åŠ  ISN æ˜¯ 32 ä½ç»å¯¹å€¼çš„è¯´æ˜
- `docs/ABSOLUTE_ISN_CHANGE.md`: è¯¦ç»†çš„ä¿®æ”¹è¯´æ˜æ–‡æ¡£
- `CHANGELOG_ABSOLUTE_ISN.md`: æœ¬æ–‡æ¡£

## ä¿®æ”¹æ•ˆæœ

### ä¿®æ”¹å‰ï¼ˆç›¸å¯¹åºåˆ—å·ï¼‰

```
Matched pairs: 2
Average score: 0.64

[1] ç½®ä¿¡åº¦: 0.61 | è¯æ®: isnC isnS ts shape(1.00) ipid*
    A: Client ISN: 0, Server ISN: 0
    B: Client ISN: 0, Server ISN: 0
    âœ“ ISN matches (å‡é˜³æ€§ï¼)

[2] ç½®ä¿¡åº¦: 0.68 | è¯æ®: isnC isnS ts shape(0.83) ipid
    A: Client ISN: 0, Server ISN: 0
    B: Client ISN: 0, Server ISN: 0
    âœ“ ISN matches (å‡é˜³æ€§ï¼)
```

### ä¿®æ”¹åï¼ˆç»å¯¹åºåˆ—å·ï¼‰

```
Matched pairs: 1
Average score: 0.40

[1] ç½®ä¿¡åº¦: 0.40 | è¯æ®: ts shape(1.00) ipid*
    A: Client ISN: 3377375738, Server ISN: 3004422537
    B: Client ISN: 1712228007, Server ISN: 1960931316
    âœ— ISN differs (æ­£ç¡®è¯†åˆ«ï¼)
    
    IPID Analysis:
      - Overlap: 673 IPIDs (90.7% ratio)
      - Force Accept: True (strong IPID)
      - Score: 0.40 (below 0.60 threshold)
```

### å…³é”®å˜åŒ–

| æŒ‡æ ‡ | ä¿®æ”¹å‰ | ä¿®æ”¹å | è¯´æ˜ |
|------|--------|--------|------|
| åŒ¹é…å¯¹æ•° | 2 | 1 | å‡å°‘å‡é˜³æ€§ |
| ç¬¬ä¸€ä¸ªåŒ¹é…ç½®ä¿¡åº¦ | 0.61 | 0.40 | ISN ä¸åŒ¹é…å¯¼è‡´å¾—åˆ†é™ä½ |
| ç¬¬ä¸€ä¸ªåŒ¹é…è¯æ® | `isnC isnS ts shape(1.00) ipid*` | `ts shape(1.00) ipid*` | å¤±å» ISN è¯æ® |
| ç¬¬äºŒä¸ªåŒ¹é… | å­˜åœ¨ | æ¶ˆå¤± | ISN ä¸åŒ¹é…è¢«æ­£ç¡®æ’é™¤ |
| ISN å€¼ | æ€»æ˜¯ 0 | çœŸå®çš„ 32 ä½å€¼ | æ¢å¤åŒºåˆ†èƒ½åŠ› |

## å½±å“åˆ†æ

### æ­£é¢å½±å“

âœ… **æé«˜åŒ¹é…å‡†ç¡®æ€§**
- å‡å°‘å‡é˜³æ€§ï¼ˆISN ä¸å†æ€»æ˜¯åŒ¹é…ï¼‰
- ISN æ¢å¤ä½œä¸ºå¼ºåŒºåˆ†ç‰¹å¾çš„èƒ½åŠ›ï¼ˆ32 ä½éšæœºæ•°ï¼Œç¢°æ’æ¦‚ç‡ < 10^-9ï¼‰

âœ… **ç»Ÿä¸€æ’ä»¶è¡Œä¸º**
- Match å’Œ Compare æ’ä»¶ç°åœ¨éƒ½ä½¿ç”¨ç»å¯¹åºåˆ—å·
- è¡Œä¸ºä¸€è‡´ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤

âœ… **æ­ç¤ºæ½œåœ¨é—®é¢˜**
- å‘ç°å¼º IPID æ¡ä»¶å¯èƒ½è¿‡äºå®½æ¾
- ä¸ºåç»­ä¼˜åŒ–æä¾›æ–¹å‘

### è´Ÿé¢å½±å“ï¼ˆç ´åæ€§å˜æ›´ï¼‰

âš ï¸ **åŒ¹é…ç»“æœå¯èƒ½å‡å°‘**
- ä¹‹å‰çš„å‡é˜³æ€§ä¼šè¢«æ’é™¤
- åŒ¹é…å¯¹æ•°å¯èƒ½å‡å°‘

âš ï¸ **ç½®ä¿¡åº¦å¯èƒ½é™ä½**
- ISN ä¸å†æ€»æ˜¯åŒ¹é…
- å¾—åˆ†å¯èƒ½é™ä½

âš ï¸ **è¯æ®å­—ç¬¦ä¸²å¯èƒ½å˜åŒ–**
- `isnC` å’Œ `isnS` è¯æ®å¯èƒ½æ¶ˆå¤±
- éœ€è¦æ›´æ–°ä¾èµ–è¯æ®å­—ç¬¦ä¸²çš„ä»£ç 

## æµ‹è¯•ç»“æœ

### å•å…ƒæµ‹è¯•
```bash
python -m pytest tests/test_plugins/test_match/test_units.py -v
```
- âœ… æ‰€æœ‰æ ¸å¿ƒæµ‹è¯•é€šè¿‡
- âœ… ISN è¯„åˆ†é€»è¾‘æ­£ç¡®
- âœ… è¿æ¥åŒ¹é…é€»è¾‘æ­£ç¡®

### é›†æˆæµ‹è¯•
```bash
python -m pytest tests/test_plugins/test_match/test_integration.py -v
```
- âœ… æ ¸å¿ƒé›†æˆæµ‹è¯•é€šè¿‡
- âš ï¸ 3 ä¸ªé‡‡æ ·ç›¸å…³æµ‹è¯•å¤±è´¥ï¼ˆå‚æ•°åç§°é”™è¯¯ï¼Œä¸æœ¬æ¬¡ä¿®æ”¹æ— å…³ï¼‰

### å®é™…æ•°æ®æµ‹è¯•
- æµ‹è¯•æ•°æ®ï¼š`/Users/ricky/Downloads/2hops/dbs_1112`
- âœ… ISN æå–æ­£ç¡®ï¼ˆéé›¶çš„ 32 ä½å€¼ï¼‰
- âœ… ISN åŒ¹é…é€»è¾‘æ­£ç¡®ï¼ˆèƒ½å¤ŸåŒºåˆ†ä¸åŒè¿æ¥ï¼‰
- âœ… å‡é˜³æ€§å‡å°‘ï¼ˆåŒ¹é…æ•°ä» 2 é™åˆ° 1ï¼‰

## è¿ç§»æŒ‡å—

### å¯¹ç°æœ‰ç”¨æˆ·çš„å»ºè®®

1. **é‡æ–°è¿è¡ŒåŒ¹é…**
   ```bash
   capmaster match -i /path/to/pcaps
   ```
   ä½¿ç”¨æ–°ç‰ˆæœ¬é‡æ–°åŒ¹é… PCAP æ–‡ä»¶

2. **æ£€æŸ¥ç»“æœå·®å¼‚**
   - å¯¹æ¯”æ–°æ—§ç»“æœ
   - åˆ†æåŒ¹é…æ•°å‡å°‘çš„åŸå› 
   - éªŒè¯æ–°ç»“æœçš„å‡†ç¡®æ€§

3. **è°ƒæ•´é˜ˆå€¼ï¼ˆå¦‚éœ€è¦ï¼‰**
   ```bash
   capmaster match -i /path/to/pcaps --threshold 0.50
   ```
   å¦‚æœåŒ¹é…æ•°è¿‡å°‘ï¼Œå¯ä»¥é€‚å½“é™ä½é˜ˆå€¼

4. **æ›´æ–°ä¾èµ–ä»£ç **
   - å¦‚æœä»£ç ä¾èµ–è¯æ®å­—ç¬¦ä¸²ï¼Œéœ€è¦æ›´æ–°
   - å¦‚æœä»£ç å‡è®¾ ISN æ€»æ˜¯ 0ï¼Œéœ€è¦ä¿®æ”¹

### é¢„æœŸè¡Œä¸ºå˜åŒ–

| åœºæ™¯ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| ç›¸åŒè¿æ¥ï¼ˆISN ç›¸åŒï¼‰ | åŒ¹é… | åŒ¹é… |
| ä¸åŒè¿æ¥ï¼ˆISN ä¸åŒï¼‰ | å¯èƒ½åŒ¹é…ï¼ˆå‡é˜³æ€§ï¼‰ | ä¸åŒ¹é…ï¼ˆæ­£ç¡®ï¼‰ |
| ç¼ºå°‘ SYN åŒ… | ISN=0ï¼Œå¯èƒ½åŒ¹é… | ISN=0ï¼Œå¯èƒ½åŒ¹é… |
| æœ‰ SYN åŒ… | ISN=0ï¼Œæ€»æ˜¯åŒ¹é… | ISN=çœŸå®å€¼ï¼ŒæŒ‰å€¼åŒ¹é… |

## åç»­å·¥ä½œ

### çŸ­æœŸï¼ˆå·²å®Œæˆï¼‰
- âœ… ä½¿ç”¨ç»å¯¹åºåˆ—å·
- âœ… æ›´æ–°æ–‡æ¡£
- âœ… éªŒè¯æµ‹è¯•

### ä¸­æœŸï¼ˆå¾…è¯„ä¼°ï¼‰
- âš ï¸ è°ƒæ•´å¼º IPID æ¡ä»¶
  - å½“å‰ï¼šIPID é‡å  â‰¥ 10 ä¸”æ¯”ä¾‹ â‰¥ 80%
  - å»ºè®®ï¼šå¢åŠ å…¶ä»–å¿…è¦æ¡ä»¶æˆ–æé«˜é˜ˆå€¼

- âš ï¸ æ”¶é›†æ›´å¤šæµ‹è¯•æ•°æ®
  - éªŒè¯æ–°ç®—æ³•çš„å‡†ç¡®æ€§
  - è¯„ä¼°å‡é˜´æ€§å’Œå‡é˜³æ€§ç‡

### é•¿æœŸï¼ˆå¾…å®ç°ï¼‰
- ğŸ“‹ å®ç°è§’è‰²äº’æ¢å°è¯•
- ğŸ“‹ å¢åŠ æ›´å¤šæ–¹å‘æ— å…³ç‰¹å¾
- ğŸ“‹ æ”¯æŒéƒ¨åˆ†å››å…ƒç»„åŒ¹é…ï¼ˆNAT åœºæ™¯ï¼‰

## ç›¸å…³æ–‡ä»¶

- `capmaster/core/connection/extractor.py` - ä¸»è¦ä¿®æ”¹
- `capmaster/core/connection/scorer.py` - æ³¨é‡Šæ›´æ–°
- `docs/MATCH_LOGIC_COMPLETE.md` - æ–‡æ¡£æ›´æ–°
- `docs/ABSOLUTE_ISN_CHANGE.md` - è¯¦ç»†è¯´æ˜
- `CHANGELOG_ABSOLUTE_ISN.md` - æœ¬æ–‡æ¡£

## å‚è€ƒ

- tshark æ–‡æ¡£: https://www.wireshark.org/docs/man-pages/tshark.html
- TCP åºåˆ—å·: https://datatracker.ietf.org/doc/html/rfc793#section-3.3
- ISN éšæœºåŒ–: https://datatracker.ietf.org/doc/html/rfc6528

## æ€»ç»“

è¿™æ¬¡ä¿®æ”¹æ˜¯ä¸€ä¸ª**é‡è¦çš„ bug ä¿®å¤**ï¼Œè§£å†³äº† ISN ç‰¹å¾å¤±æ•ˆçš„é—®é¢˜ï¼š

1. âœ… **ä¿®å¤äº†æ ¸å¿ƒé—®é¢˜**ï¼šISN ä»ç›¸å¯¹å€¼æ”¹ä¸ºç»å¯¹å€¼
2. âœ… **æé«˜äº†å‡†ç¡®æ€§**ï¼šå‡å°‘å‡é˜³æ€§ï¼Œå¢å¼ºåŒºåˆ†èƒ½åŠ›
3. âœ… **ç»Ÿä¸€äº†è¡Œä¸º**ï¼šMatch å’Œ Compare æ’ä»¶ç°åœ¨ä¸€è‡´
4. âš ï¸ **ç ´åæ€§å˜æ›´**ï¼šåŒ¹é…ç»“æœå¯èƒ½ä¼šå˜åŒ–ï¼Œéœ€è¦ç”¨æˆ·é‡æ–°è¿è¡Œ

**å»ºè®®æ‰€æœ‰ç”¨æˆ·å‡çº§åˆ°æ–°ç‰ˆæœ¬ï¼Œå¹¶é‡æ–°è¿è¡ŒåŒ¹é…ä»¥è·å¾—æ›´å‡†ç¡®çš„ç»“æœã€‚**

