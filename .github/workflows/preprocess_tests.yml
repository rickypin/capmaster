name: Preprocess plugin tests

on:
  push:
    paths:
      - 'capmaster/plugins/preprocess/**'
      - 'tests/test_plugins/test_preprocess/**'
      - 'docs/DESIGN_preprocess_and_config.md'
      - '.github/workflows/preprocess_tests.yml'
  pull_request:
    paths:
      - 'capmaster/plugins/preprocess/**'
      - 'tests/test_plugins/test_preprocess/**'
      - 'docs/DESIGN_preprocess_and_config.md'
      - '.github/workflows/preprocess_tests.yml'

jobs:
  test-preprocess:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Wireshark CLI tools (tshark/editcap/capinfos)
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y tshark

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run preprocess integration tests
        run: |
          pytest -q tests/test_plugins/test_preprocess/test_integration.py

