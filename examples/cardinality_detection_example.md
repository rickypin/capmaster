# 基数检测示例

## 基本用法

使用 `--endpoint-stats` 参数启用端点统计和服务端检测：

```bash
python -m capmaster match \
  -i file1.pcap,file2.pcap \
  --endpoint-stats
```

## 示例场景

### 场景1: Web服务器（多客户端访问）

**数据特征**：
- 1个Web服务器 `192.168.1.100:8080`
- 50个不同的客户端IP访问该服务器
- 每个客户端使用不同的临时端口

**基数分析**：
```
服务端 192.168.1.100:8080 的基数 = 50 (服务50个客户端)
每个客户端端口的基数 = 1 (只连接1个服务端)
```

**检测结果**：
```
[1] Count: 50 | Confidence: HIGH
    File A: Client 10.0.0.* → Server 192.168.1.100:8080
    File B: Client 10.0.0.* → Server 192.168.1.100:8080
```

**方法**: `CARDINALITY_50v1` (基数50:1，HIGH置信度)

---

### 场景2: 数据库服务器（少量客户端）

**数据特征**：
- 1个数据库服务器 `10.0.2.100:26301`（非标准端口）
- 3个应用服务器作为客户端
- 没有SYN包（中途抓包）

**基数分析**：
```
服务端 10.0.2.100:26301 的基数 = 3
每个客户端端口的基数 = 1
```

**检测结果**：
```
[1] Count: 15 | Confidence: MEDIUM
    File A: Client 10.0.1.* → Server 10.0.2.100:26301
    File B: Client 10.0.1.* → Server 10.0.2.100:26301
```

**方法**: `CARDINALITY_3v1` (基数3:1，MEDIUM置信度)

**说明**：
- 虽然端口26301不在知名端口列表中
- 虽然没有SYN包
- 但基数分析仍能正确识别服务端

---

### 场景3: 负载均衡场景

**数据特征**：
- 100个客户端
- 通过负载均衡器访问3个后端服务器
- 每个服务器处理约33个客户端

**基数分析**：
```
服务端1 10.0.2.101:8080 的基数 = 33
服务端2 10.0.2.102:8080 的基数 = 34
服务端3 10.0.2.103:8080 的基数 = 33
每个客户端端口的基数 = 1
```

**检测结果**：
```
[1] Count: 33 | Confidence: HIGH
    File A: Client 10.0.1.* → Server 10.0.2.101:8080
    File B: Client 10.0.1.* → Server 10.0.2.101:8080

[2] Count: 34 | Confidence: HIGH
    File A: Client 10.0.1.* → Server 10.0.2.102:8080
    File B: Client 10.0.1.* → Server 10.0.2.102:8080

[3] Count: 33 | Confidence: HIGH
    File A: Client 10.0.1.* → Server 10.0.2.103:8080
    File B: Client 10.0.1.* → Server 10.0.2.103:8080
```

---

### 场景4: 点对点连接（基数分析失效）

**数据特征**：
- 2个节点之间的直接连接
- 每个节点既是客户端又是服务端

**基数分析**：
```
节点1 10.0.0.1:50001 的基数 = 1
节点2 10.0.0.2:60001 的基数 = 1
```

**检测结果**：
```
[1] Count: 1 | Confidence: VERY_LOW
    File A: Client 10.0.0.1 → Server 10.0.0.2:60001
    File B: Client 10.0.0.1 → Server 10.0.0.2:60001
```

**方法**: `FALLBACK_PORT_COMPARISON` (基数分析无法判断，使用兜底逻辑)

**说明**：
- 基数相同（1:1），无法通过基数判断
- 回退到端口号比较（较小端口号作为服务端）

---

## 检测优先级

系统使用以下优先级进行服务端检测：

1. **SYN包方向** (HIGH) - 最可靠
2. **知名端口** (HIGH/MEDIUM) - 80, 443, 3306等
3. **基数分析** (HIGH/MEDIUM) - 新增！
4. **系统端口** (MEDIUM) - 端口 < 1024
5. **端口比较** (VERY_LOW) - 兜底逻辑

## 置信度说明

| 置信度 | 基数条件 | 说明 |
|--------|----------|------|
| HIGH | 基数 ≥ 5 | 服务端服务5个或更多客户端 |
| MEDIUM | 基数 2-4 或 比率 ≥ 3:1 | 服务端服务2-4个客户端，或基数比率显著 |
| UNKNOWN | 基数相近 | 无法通过基数判断 |

## 输出到文件

将统计结果保存到文件：

```bash
python -m capmaster match \
  -i file1.pcap,file2.pcap \
  --endpoint-stats \
  --endpoint-stats-output stats.txt
```

## 调试技巧

### 查看检测方法

检测方法字段包含基数信息，可用于调试：

```
CARDINALITY_63v1          # 基数 63:1，未交换
CARDINALITY_SWAPPED_5v1   # 基数 5:1，已交换（原始判断错误）
CARDINALITY_RATIO_10v3    # 基数比率 10:3
CARDINALITY_UNCLEAR_1v1   # 基数相同，无法判断
```

### 理解基数值

- **第一个数字**：当前判断为服务端的那一端的基数
- **第二个数字**：当前判断为客户端的那一端的基数
- **SWAPPED**：表示原始连接的server/client字段被交换了

## 最佳实践

1. **数据集完整性**：确保PCAP文件包含足够多的连接以进行基数分析
2. **时间范围**：捕获足够长的时间段以观察服务端的多客户端特征
3. **结合其他方法**：基数分析与SYN包、端口启发式等方法互补
4. **验证结果**：对于MEDIUM或VERY_LOW置信度的结果，建议人工验证

## 常见问题

**Q: 为什么有些连接的置信度是VERY_LOW？**

A: 可能的原因：
- 只有1-2个连接，基数分析无法发挥作用
- 点对点连接，两端基数相同
- 没有SYN包，且端口不在知名列表中

**Q: 基数分析需要多少连接才有效？**

A: 
- 最少2个连接（MEDIUM置信度）
- 建议5个或更多连接（HIGH置信度）
- 连接越多，统计越可靠

**Q: 基数分析会增加多少内存开销？**

A: 
- 每个唯一的 IP:Port 组合需要存储一个集合
- 对于10000个连接，通常只需要几MB内存
- 内存开销与唯一端点数量成正比，而非连接总数

**Q: 可以禁用基数分析吗？**

A: 
- 当前版本不支持单独禁用
- 如果数据集很小（<10个连接），基数分析会自动退化到其他方法
- 未来版本可能会添加配置选项

